<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>UNEB Automatic Subject Summary System</title>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary:#1e40af;
      --secondary:#0ea5e9;
      --bg:#f1f5f9;
      --card:#ffffff;
      --text:#0f172a;
    }

    body { margin:0; font-family:Segoe UI, Arial; background:var(--bg); color:var(--text); }

    header { background:linear-gradient(135deg,var(--primary),var(--secondary)); color:#fff; padding:20px; text-align:center; }

    main { max-width:1200px; margin:auto; padding:20px; }

    .card { background:var(--card); padding:20px; border-radius:10px; margin-bottom:20px; box-shadow:0 6px 15px rgba(0,0,0,.08); }

    .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:15px; }

    input, button { padding:10px; width:100%; border-radius:6px; border:1px solid #cbd5f5; }

    button { background:var(--primary); color:#fff; font-weight:bold; cursor:pointer; border:none; }
    button:hover { background:#1e3a8a; }

    table { width:100%; border-collapse:collapse; margin-top:10px; font-size:13px; }
    th,td { border:1px solid #e2e8f0; padding:8px; text-align:center; }
    th { background:#e0e7ff; }

    footer { text-align:center; padding:15px; color:#64748b; font-size:13px; }

    @media print {
      button,input { display:none; }
      body { background:#fff; }
      .card { box-shadow:none; }
    }
  </style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen" class="card" style="max-width:400px;margin:40px auto;">
  <h2>School Login (Demo)</h2>
  <input id="loginSchool" placeholder="School Code" />
  <input id="loginPass" type="password" placeholder="Password" />
  <br><br>
  <button onclick="login()">Login</button>
  <p id="loginMsg" style="color:red"></p>
</div>

<div id="app" style="display:none;">

<header>
  <h1>UNEB Automatic Subject Summary</h1>
  <p>Grading • Charts • Reports</p>
</header>

<main>

  <div class="card">
    <h2>School Information</h2>
    <div class="grid">
      <input id="school" placeholder="School Name" />
      <input id="year" placeholder="Year" />
    </div>
  </div>

  <div class="card">
    <h2>Upload Sheet1 Results</h2>
    <input type="file" id="file" accept=".xlsx" />
    <br><br>
    <button onclick="generateReport()">Generate UNEB Report</button>
  </div>

  <div class="card" id="summary"></div>
  <div class="card" id="genderSummary"></div>

  <div class="card">
    <h2>Performance Charts</h2>
    <select id="subjectSelect" onchange="chart()"></select><br><br><canvas id="chart"></canvas>
  </div>

  <div class="card">
    <button onclick="exportExcel()">Export Summary to Excel</button>
    <button onclick="window.print()">Print UNEB Report</button>
  </div>

</main>

<footer>© UNEB Results Automation System</footer>

</div>

<script>
// DEMO LOGIN
const USERS = { NLSC:'2025', RUBONGI:'1234' };
function login(){
  const s=document.getElementById('loginSchool').value.toUpperCase();
  const p=document.getElementById('loginPass').value;
  if(USERS[s] && USERS[s]===p){
    loginScreen.style.display='none';
    app.style.display='block';
    school.value=s+' SECONDARY SCHOOL';
  } else loginMsg.innerText='Invalid login';
}

let summaryData={}, genderData={};
const GRADES=['A','B','C','D','E','X'];

function generateReport(){
  const file=fileInput.files[0]; if(!file) return alert('Upload Excel file');
  const r=new FileReader();
  r.onload=e=>{
    const wb=XLSX.read(e.target.result,{type:'binary'});
    const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1});
    process(rows);
  };
  r.readAsBinaryString(file);
}

function process(rows){
  const h=rows[0].map(x=>x.toString().toUpperCase());
  const sIdx=h.findIndex(x=>x.includes('SUBJECT'));
  const sexIdx=h.indexOf('SEX');
  summaryData={}; genderData={};

  for(let i=1;i<rows.length;i++){
    const sex=(rows[i][sexIdx]||'').toUpperCase();
    (rows[i][sIdx]||'').toString().split(' ').forEach(it=>{
      const [sub,g0]=it.split('-'); if(!sub) return;
      const g=g0||'X';
      if(!summaryData[sub]){ summaryData[sub]={}; GRADES.forEach(x=>summaryData[sub][x]=0); }
      summaryData[sub][g]++;
      if(!genderData[sub]){ genderData[sub]={}; GRADES.forEach(x=>genderData[sub][x]={M:0,F:0}); }
      if(genderData[sub][g][sex]!==undefined) genderData[sub][g][sex]++;
    });
  }
  render(); chart();
}

function render(){
  const subjects=Object.keys(summaryData).sort((a,b)=>a==='PROJECT'?1:b==='PROJECT'?-1:a.localeCompare(b));
  let html=`<h2>${school.value}</h2><p><b>UNEB Subject Summary – ${year.value}</b></p>`;
  html+='<table><tr><th>#</th><th>SUBJECT</th><th>LEARNERS</th>';
  GRADES.forEach(g=>html+=`<th>${g}</th>`); html+='</tr>';
  subjects.forEach((s,i)=>{
    const t=GRADES.reduce((a,g)=>a+summaryData[s][g],0);
    html+=`<tr><td>${i+1}</td><td>${s}</td><td>${t}</td>`;
    GRADES.forEach(g=>html+=`<td>${summaryData[s][g]}</td>`);
    html+='</tr>';
  }); html+='</table>';
  summary.innerHTML=html;

  let ghtml='<h3>Gender Summary</h3>';
  subjects.forEach(s=>{
    ghtml+=`<h4>${s}</h4><table><tr><th>Grade</th><th>Male</th><th>Female</th></tr>`;
    GRADES.forEach(g=>ghtml+=`<tr><td>${g}</td><td>${genderData[s][g].M}</td><td>${genderData[s][g].F}</td></tr>`);
    ghtml+='</table>';
  }); genderSummary.innerHTML=ghtml;
}

function chart(){
  const sel=document.getElementById('subjectSelect');
  if(!sel.options.length){
    Object.keys(summaryData).forEach(s=>{
      const o=document.createElement('option'); o.value=s; o.text=s; sel.add(o);
    });
  }
  const s=sel.value||sel.options[0]?.value; if(!s) return;
  if(window._chart) window._chart.destroy();
  window._chart=new Chart(document.getElementById('chart'),{
    type:'bar',
    data:{ labels:GRADES, datasets:[{label:s,data:GRADES.map(g=>summaryData[s][g])}] }
  });
}] }
  });
}

function exportExcel(){
  const wb=XLSX.utils.book_new();
  const sdata=[[ 'SUBJECT','LEARNERS',...GRADES ]];
  Object.keys(summaryData).forEach(s=>sdata.push([s,GRADES.reduce((a,g)=>a+summaryData[s][g],0),...GRADES.map(g=>summaryData[s][g])]));
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(sdata),'Subject Summary');

  const gdata=[[ 'SUBJECT','GRADE','MALE','FEMALE' ]];
  Object.keys(genderData).forEach(s=>GRADES.forEach(g=>gdata.push([s,g,genderData[s][g].M,genderData[s][g].F])));
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(gdata),'Gender Summary');

  XLSX.writeFile(wb,'UNEB_Full_Summary.xlsx');
}
</script>

</body>
</html>
