<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>UNEB Automatic Report System</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body{font-family:Arial;background:#f4f6fb;margin:0}
header{background:#1a4d8f;color:#fff;padding:15px;text-align:center}
.container{padding:20px}
table{width:100%;border-collapse:collapse;margin-top:20px;background:#fff}
th,td{border:1px solid #ccc;padding:6px;text-align:center;font-size:14px}
th{background:#e9eef3}
button{background:#1a4d8f;color:#fff;padding:10px 16px;border:none;border-radius:5px;cursor:pointer;margin:5px}
button:hover{background:#163f73}
input{padding:8px;margin:5px;width:100%}

@media print{
  button,input{display:none}
  body{background:#fff}
}
</style>
</head>

<body>

<header>
  <h1 id="schoolHeader">UNEB AUTOMATIC SUBJECT SUMMARY</h1>
</header>

<!-- LOGIN -->
<div id="loginBox" style="max-width:400px;margin:60px auto;background:#fff;padding:20px;border-radius:10px">
  <h2 style="text-align:center">School Login (Demo)</h2>
  <input id="username" placeholder="Username">
  <input id="password" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
  <p id="loginError" style="color:red;text-align:center"></p>
</div>

<!-- APP -->
<div id="app" style="display:none">
<div class="container">

<input id="schoolName" placeholder="School Name">
<input id="year" placeholder="Year">
<input type="file" id="file" accept=".xlsx">

<button onclick="generateReport()">Generate UNEB Report</button>
<button onclick="exportSubject()">Export Subject Summary</button>
<button onclick="exportGender()">Export Gender Summary</button>
<button onclick="window.print()">Print UNEB Report</button>

<div id="subjectSummary"></div>
<div id="genderSummary"></div>

</div>
</div>

<script>
/* ---------- LOGIN ---------- */
function login(){
  if(username.value==="admin" && password.value==="1234"){
    loginBox.style.display="none";
    app.style.display="block";
  }else{
    loginError.innerText="Use admin / 1234";
  }
}

/* ---------- STORES ---------- */
let subjects = {};
let gender = {};

/* ---------- GENERATE REPORT ---------- */
function generateReport(){
  const file = document.getElementById("file").files[0];
  if(!file){ alert("Upload Excel file"); return; }

  const reader = new FileReader();
  reader.onload = e => {
    const wb = XLSX.read(e.target.result,{type:"binary"});
    const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

    subjects = {};
    gender = {};

    rows.forEach(row=>{
      const sex = (row.SEX || "").toUpperCase();

      // ðŸ”´ FIND SUBJECT COLUMN DYNAMICALLY
      let subjectCell = "";
      Object.keys(row).forEach(k=>{
        if(String(row[k]).includes("-")) subjectCell = row[k];
      });
      if(!subjectCell) return;

      subjectCell.toString().split(" ").forEach(pair=>{
        if(!pair.includes("-")) return;

        let [sub, grade] = pair.split("-");
        sub = sub.trim().toUpperCase();
        grade = grade.trim().toUpperCase();
        if(!["A","B","C","D","E","X"].includes(grade)) grade="X";

        if(!subjects[sub]){
          subjects[sub] = {sat:0,A:0,B:0,C:0,D:0,E:0,X:0};
        }

        subjects[sub].sat++;
        subjects[sub][grade]++;

        if(!gender[sub]){
          gender[sub] = {
            MA:0,MB:0,MC:0,MD:0,ME:0,
            FA:0,FB:0,FC:0,FD:0,FE:0
          };
        }

        if(sex==="M" && grade!=="X") gender[sub]["M"+grade]++;
        if(sex==="F" && grade!=="X") gender[sub]["F"+grade]++;
      });
    });

    schoolHeader.innerText =
      (schoolName.value||"SCHOOL")+" â€“ UNEB REPORT "+(year.value||"");

    renderSubject();
    renderGender();
  };
  reader.readAsBinaryString(file);
}

/* ---------- SUBJECT TABLE ---------- */
function renderSubject(){
  let html=`<h2>Subject Summary</h2>
  <table>
  <tr>
  <th>Subject</th><th>Sat</th>
  <th>A</th><th>%A</th>
  <th>B</th><th>%B</th>
  <th>C</th><th>%C</th>
  <th>D</th><th>%D</th>
  <th>E</th><th>%E</th>
  <th>X</th>
  </tr>`;

  Object.keys(subjects).sort((a,b)=>{
    if(a==="PROJECT") return 1;
    if(b==="PROJECT") return -1;
    return a.localeCompare(b);
  }).forEach(s=>{
    const x=subjects[s];
    const pct=g=>((x[g]/x.sat)*100||0).toFixed(1);
    html+=`<tr>
      <td>${s}</td><td>${x.sat}</td>
      <td>${x.A}</td><td>${pct("A")}</td>
      <td>${x.B}</td><td>${pct("B")}</td>
      <td>${x.C}</td><td>${pct("C")}</td>
      <td>${x.D}</td><td>${pct("D")}</td>
      <td>${x.E}</td><td>${pct("E")}</td>
      <td>${x.X}</td>
    </tr>`;
  });

  html+="</table>";
  subjectSummary.innerHTML=html;
}

/* ---------- GENDER TABLE ---------- */
function renderGender(){
  let html=`<h2>Gender Summary</h2>
  <table>
  <tr>
  <th>Subject</th>
  <th>MA</th><th>MB</th><th>MC</th><th>MD</th><th>ME</th>
  <th>FA</th><th>FB</th><th>FC</th><th>FD</th><th>FE</th>
  </tr>`;

  Object.keys(gender).forEach(s=>{
    const g=gender[s];
    html+=`<tr>
      <td>${s}</td>
      <td>${g.MA}</td><td>${g.MB}</td><td>${g.MC}</td><td>${g.MD}</td><td>${g.ME}</td>
      <td>${g.FA}</td><td>${g.FB}</td><td>${g.FC}</td><td>${g.FD}</td><td>${g.FE}</td>
    </tr>`;
  });

  html+="</table>";
  genderSummary.innerHTML=html;
}

/* ---------- EXPORTS ---------- */
function exportSubject(){
  const data=Object.keys(subjects).map(s=>({Subject:s,...subjects[s]}));
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(data),"Subject Summary");
  XLSX.writeFile(wb,"subject_summary.xlsx");
}

function exportGender(){
  const data=Object.keys(gender).map(s=>({Subject:s,...gender[s]}));
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(data),"Gender Summary");
  XLSX.writeFile(wb,"gender_summary.xlsx");
}
</script>

</body>
</html>
