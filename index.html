<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>UNEB Analytics System</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>

body{
  font-family:"Segoe UI",Arial,sans-serif;
  margin:20px;
  background:#f4f6f9;
}

h1,h2,h3{
  text-align:center;
  margin:4px 0;
}

button{
  padding:8px 14px;
  border:none;
  border-radius:5px;
  background:#1e3a8a;
  color:white;
  font-weight:600;
  cursor:pointer;
}

button:hover{ background:#162d6b; }

input{ padding:6px; margin:5px; }

table{
  width:100%;
  border-collapse:collapse;
  font-size:12px;
  margin-top:8px;
}

th{
  background:#1e3a8a;
  color:white;
  padding:5px;
}

td{
  padding:4px;
  text-align:center;
}

th,td{ border:1px solid #ccc; }

tr:nth-child(even){ background:#f2f4f8; }

tfoot td{
  font-weight:bold;
  background:#e2e8f0;
}

.report-box{
  background:white;
  padding:12px;
  border-radius:8px;
  box-shadow:0 0 10px rgba(0,0,0,0.1);
}

.summary-cards{
  display:flex;
  justify-content:space-around;
  margin-top:10px;
  font-weight:bold;
}

.card{
  background:#e0f2fe;
  padding:8px;
  border-radius:6px;
}

.signature{
  margin-top:20px;
  font-size:12px;
}

.signature-line{
  margin-top:25px;
}

#app{ display:none; }

/* ================= PRINT SETTINGS ================= */

@page{
  size: A4 landscape;
  margin:10mm;
}

@media print{

  body{
    background:white;
    margin:0;
  }

  button,input{
    display:none;
  }

  .report-box{
    box-shadow:none;
    padding:5px;
  }

  table{
    font-size:10px;
  }

  h1,h2,h3{
    margin:2px 0;
  }

  .summary-cards{
    margin-top:5px;
  }

  .signature{
    margin-top:10px;
  }

  *{
    page-break-inside:avoid !important;
  }
}

</style>
</head>
<body>

<div id="loginBox">
<h2>Login</h2>
<input id="username" placeholder="Username"><br>
<input id="password" type="password" placeholder="Password"><br>
<button onclick="login()">Login</button>
<p id="loginError" style="color:red;"></p>
</div>

<div id="app">

<h1 id="schoolHeader"></h1>

<input id="schoolName" placeholder="School Name">
<input id="year" placeholder="Year">
<input type="file" id="file" accept=".xlsx,.xls">
<button onclick="generateReport()">Generate Report</button>

<br><br>

<button onclick="printReport()">Print</button>
<button onclick="downloadPDF()">Export PDF</button>
<button onclick="exportExcel()">Export Excel</button>

<br><br>

<div id="reportArea" class="report-box">
<div id="subjectSummary"></div>
<div id="genderSummary"></div>
<div id="analytics"></div>

<div class="signature">
  <div class="signature-line">
    Signature: ..............................................................
  </div>
  <br>
  <strong>MAWERERE FRANCIS</strong><br>
  In charge Students Data<br>
  Contact: 0788222315<br>
  Email: mawererefrancis@gmail.com
</div>

</div>

</div>

<script>

function login(){
 if(username.value==="admin" && password.value==="1234"){
  loginBox.style.display="none";
  app.style.display="block";
 }else{
  loginError.innerText="Use admin / 1234";
 }
}

let subjects = {};
let gender = {};

function generateReport(){

 const file = document.getElementById("file").files[0];
 if(!file){ alert("Upload Excel file"); return; }

 const reader = new FileReader();

 reader.onload = e => {

  const wb = XLSX.read(e.target.result,{type:"array"});
  const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

  subjects = {};
  gender = {};

  rows.forEach(row=>{

   const sex = String(row.Sex || "").toUpperCase().trim();
   const project = String(row["PROJECT WORK"] || "X").toUpperCase().trim();
   const achievements = String(row["SUBJECT ACHIEVEMENTS"] || "").trim();

   if(!achievements) return;

   const valid = ["A","B","C","D","E","X"];
   const pg = valid.includes(project)?project:"X";

   achievements.split(" ").forEach(item=>{

     if(!item.includes("-")) return;

     const [subjectRaw,gradeRaw] = item.split("-");
     const subject = subjectRaw.toUpperCase().trim();
     const g = valid.includes(gradeRaw)?gradeRaw:"X";

     if(!subjects[subject]){
       subjects[subject]={sat:0,A:0,B:0,C:0,D:0,E:0,X:0,PA:0,PB:0,PC:0,PD:0,PE:0,PX:0};
     }

     subjects[subject].sat++;
     subjects[subject][g]++;
     subjects[subject]["P"+pg]++;

     if(!gender[subject]){
       gender[subject]={MA:0,MB:0,MC:0,MD:0,ME:0,FA:0,FB:0,FC:0,FD:0,FE:0};
     }

     if(sex==="M" && g!=="X") gender[subject]["M"+g]++;
     if(sex==="F" && g!=="X") gender[subject]["F"+g]++;

   });

  });

  schoolHeader.innerHTML =
  `<h2>${schoolName.value||"SCHOOL NAME"}</h2>
   <h3>UNEB REPORT ${year.value||""}</h3>`;

  renderSubject();
  renderGender();
  renderAnalytics();
 };

 reader.readAsArrayBuffer(file);
}


/* SUBJECT TABLE */
function renderSubject(){

 let totals={A:0,B:0,C:0,D:0,E:0};

 let h=`<h2>Subject Summary</h2>
 <table>
 <tr>
 <th>Rank</th>
 <th>Subject</th><th>Sat</th>
 <th>A</th><th>%A</th>
 <th>B</th><th>%B</th>
 <th>C</th><th>%C</th>
 <th>D</th><th>%D</th>
 <th>E</th><th>%E</th>
 <th>X</th>
 </tr>`;

 let sorted=Object.keys(subjects).sort((a,b)=>{
   return (subjects[b].A/subjects[b].sat)-(subjects[a].A/subjects[a].sat);
 });

 sorted.forEach((s,i)=>{

  let x=subjects[s];

  totals.A+=x.A;
  totals.B+=x.B;
  totals.C+=x.C;
  totals.D+=x.D;
  totals.E+=x.E;

  let p=g=>x.sat?((x[g]/x.sat)*100).toFixed(1):"0.0";

  h+=`<tr>
  <td>${i+1}</td>
  <td>${s}</td>
  <td>${x.sat}</td>
  <td>${x.A}</td><td>${p("A")}</td>
  <td>${x.B}</td><td>${p("B")}</td>
  <td>${x.C}</td><td>${p("C")}</td>
  <td>${x.D}</td><td>${p("D")}</td>
  <td>${x.E}</td><td>${p("E")}</td>
  <td>${x.X}</td>
  </tr>`;
 });

 /* PROJECT ROW */
 let projectTotals={PA:0,PB:0,PC:0,PD:0,PE:0,PX:0};
 Object.values(subjects).forEach(x=>{
   projectTotals.PA+=x.PA;
   projectTotals.PB+=x.PB;
   projectTotals.PC+=x.PC;
   projectTotals.PD+=x.PD;
   projectTotals.PE+=x.PE;
   projectTotals.PX+=x.PX;
 });

 h+=`<tr style="background:#e0f2fe;font-weight:bold">
 <td></td>
 <td>PROJECT WORK</td><td></td>
 <td>${projectTotals.PA}</td><td></td>
 <td>${projectTotals.PB}</td><td></td>
 <td>${projectTotals.PC}</td><td></td>
 <td>${projectTotals.PD}</td><td></td>
 <td>${projectTotals.PE}</td><td></td>
 <td>${projectTotals.PX}</td>
 </tr>`;

 /* TOTAL ROW */
 h+=`<tfoot>
 <tr>
 <td></td>
 <td>TOTAL (Aâ€“E)</td><td></td>
 <td>${totals.A}</td><td></td>
 <td>${totals.B}</td><td></td>
 <td>${totals.C}</td><td></td>
 <td>${totals.D}</td><td></td>
 <td>${totals.E}</td><td></td>
 <td></td>
 </tr>
 </tfoot></table>`;

 subjectSummary.innerHTML=h;
}


/* GENDER TABLE */
function renderGender(){

 let totals={MA:0,MB:0,MC:0,MD:0,ME:0,FA:0,FB:0,FC:0,FD:0,FE:0};

 let h=`<h2>Gender Summary</h2>
 <table>
 <tr>
 <th>Subject</th>
 <th>MA</th><th>MB</th><th>MC</th><th>MD</th><th>ME</th>
 <th>FA</th><th>FB</th><th>FC</th><th>FD</th><th>FE</th>
 </tr>`;

 Object.keys(gender).sort().forEach(s=>{
  let g=gender[s];
  Object.keys(totals).forEach(k=>totals[k]+=g[k]);

  h+=`<tr>
  <td>${s}</td>
  <td>${g.MA}</td><td>${g.MB}</td><td>${g.MC}</td><td>${g.MD}</td><td>${g.ME}</td>
  <td>${g.FA}</td><td>${g.FB}</td><td>${g.FC}</td><td>${g.FD}</td><td>${g.FE}</td>
  </tr>`;
 });

 h+=`<tfoot>
 <tr>
 <td>TOTAL</td>
 <td>${totals.MA}</td><td>${totals.MB}</td><td>${totals.MC}</td>
 <td>${totals.MD}</td><td>${totals.ME}</td>
 <td>${totals.FA}</td><td>${totals.FB}</td><td>${totals.FC}</td>
 <td>${totals.FD}</td><td>${totals.FE}</td>
 </tr>
 </tfoot></table>`;

 genderSummary.innerHTML=h;
}


/* ANALYTICS */
function renderAnalytics(){

 let totalA=0,totalSat=0;

 Object.values(subjects).forEach(x=>{
   totalA+=x.A;
   totalSat+=x.sat;
 });

 let mean=(totalA/totalSat*100)||0;

 let comment="";
 if(mean>=40) comment="Excellent Performance";
 else if(mean>=25) comment="Good Performance";
 else comment="Needs Improvement";

 analytics.innerHTML=`
 <div class="summary-cards">
   <div class="card">School %A: ${mean.toFixed(1)}%</div>
   <div class="card">${comment}</div>
 </div>`;
}


/* PRINT */
function printReport(){ window.print(); }

/* PDF */
function downloadPDF(){
 html2pdf().set({
   margin:5,
   filename:"UNEB_Report.pdf",
   html2canvas:{scale:2},
   jsPDF:{orientation:"landscape"}
 }).from(document.getElementById("reportArea")).save();
}

/* EXCEL */
function exportExcel(){
 let data=[["Subject","Sat","A","B","C","D","E","X"]];
 Object.keys(subjects).forEach(s=>{
  let x=subjects[s];
  data.push([s,x.sat,x.A,x.B,x.C,x.D,x.E,x.X]);
 });
 const ws=XLSX.utils.aoa_to_sheet(data);
 const wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,ws,"Summary");
 XLSX.writeFile(wb,"UNEB_Report.xlsx");
}

</script>
</body>
</html>
