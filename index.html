<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>UNEB Automatic Subject Summary System</title>

  <!-- SheetJS for Excel import/export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Chart.js for graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background:#f4f6f9; }
    h1,h2 { margin-bottom: 5px; }
    input, select, button { padding: 8px; margin: 5px 0; }
    button { cursor: pointer; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; background:#fff; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #e9eef3; }
    .card { background:#fff; padding:15px; margin-top:15px; border-radius:6px; box-shadow:0 2px 5px rgba(0,0,0,.08); }
    canvas { max-width: 600px; margin-top:20px; }
  </style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen" class="card">
  <h2>School Login</h2>
  <input id="loginSchool" placeholder="School Code" />
  <input id="loginPass" type="password" placeholder="Password" />
  <br>
  <button onclick="login()">Login</button>
  <p id="loginMsg" style="color:red"></p>
</div>

<div id="app" style="display:none;">

<h1>UNEB Automatic Subject Summary</h1>

<div class="card">
  <h2>School Details</h2>
  <input id="school" placeholder="School Name" />
  <input id="year" placeholder="Year (e.g. 2025)" />
</div>

<div class="card">
  <h2>1Ô∏è‚É£ Upload Excel File (Sheet1)</h2>
  <input type="file" id="file" accept=".xlsx" />
  <br>
  <button onclick="generateReport()">üñ±Ô∏è Generate UNEB Report</button>
  <button onclick="exportExcel()">üì§ Export Summary to Excel</button>
</div>

<div class="card" id="summary"></div>
<div class="card"><canvas id="chart"></canvas></div>

<script>
// SIMPLE SCHOOL LOGIN (DEMO)
const USERS = {
  "RUBONGI": "1234",
  "NLSC": "2025"
};

function login() {
  const s = document.getElementById('loginSchool').value.trim().toUpperCase();
  const p = document.getElementById('loginPass').value.trim();

  if (USERS[s] && USERS[s] === p) {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    document.getElementById('school').value = s + ' SECONDARY SCHOOL';
  } else {
    document.getElementById('loginMsg').innerText = 'Invalid login details';
  }
}


let summaryData = {};
let totalCandidates = 0;

const GRADES = ['A','B','C','D','E','F'];

function generateReport() {
  const fileInput = document.getElementById('file');
  if (!fileInput.files.length) return alert('Upload Excel file first');

  const reader = new FileReader();
  reader.onload = e => {
    const wb = XLSX.read(e.target.result, { type: 'binary' });
    const ws = wb.Sheets[wb.SheetNames[0]]; // Sheet1
    const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });

    processRows(rows);
  };
  reader.readAsBinaryString(fileInput.files[0]);
}

function processRows(rows) {
  const headers = rows[0].map(h => h.toString().toUpperCase());
  const subjIdx = headers.findIndex(h => h.includes('SUBJECT'));
  const projIdx = headers.findIndex(h => h.includes('PROJECT'));

  summaryData = {};
  totalCandidates = 0;

  for (let i = 1; i < rows.length; i++) {
    totalCandidates++;
    const achievements = rows[i][subjIdx] || '';
    const project = rows[i][projIdx] || '';

    achievements.toString().split(' ').forEach(item => {
      const [sub, grade] = item.split('-');
      if (!sub || !grade) return;
      if (!summaryData[sub]) initSubject(sub);
      if (summaryData[sub][grade] !== undefined) summaryData[sub][grade]++;
    });

    if (project) {
      if (!summaryData['PROJECT']) initSubject('PROJECT');
      if (summaryData['PROJECT'][project] !== undefined) summaryData['PROJECT'][project]++;
    }
  }

  renderSummary();
  drawChart();
}

function initSubject(subject) {
  summaryData[subject] = {};
  GRADES.forEach(g => summaryData[subject][g] = 0);
}

function renderSummary() {
  const school = document.getElementById('school').value || 'SCHOOL NAME';
  const year = document.getElementById('year').value || 'YEAR';

  let html = `<h2>${school}</h2><p>UNEB Subject Summary - ${year}</p>`;
  html += '<table><tr><th>S/NO</th><th>SUBJECT</th>';

  GRADES.forEach(g => html += `<th>${g}</th><th>%${g}</th>`);
  html += '</tr>';

  let i = 1;
  for (const sub in summaryData) {
    html += `<tr><td>${i++}</td><td>${sub}</td>`;
    GRADES.forEach(g => {
      const v = summaryData[sub][g];
      html += `<td>${v}</td><td>${((v/totalCandidates)*100).toFixed(1)}</td>`;
    });
    html += '</tr>';
  }

  html += '</table>';
  document.getElementById('summary').innerHTML = html;
}

function drawChart() {
  const firstSubject = Object.keys(summaryData)[0];
  if (!firstSubject) return;

  const ctx = document.getElementById('chart');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: GRADES,
      datasets: [{
        label: firstSubject,
        data: GRADES.map(g => summaryData[firstSubject][g])
      }]
    }
  });
}

function exportExcel() {
  const rows = [["SUBJECT", ...GRADES.flatMap(g => [g, `%${g}`])]];

  for (const sub in summaryData) {
    const row = [sub];
    GRADES.forEach(g => {
      row.push(summaryData[sub][g]);
      row.push(((summaryData[sub][g]/totalCandidates)*100).toFixed(1));
    });
    rows.push(row);
  }

  const ws = XLSX.utils.aoa_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Subject Summary');
  XLSX.writeFile(wb, 'UNEB_Subject_Summary.xlsx');
}
</script>

</div>
</body>
</html>
