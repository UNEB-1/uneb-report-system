<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>UNEB Professional Report System</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>

body{
  font-family: "Segoe UI", Arial, sans-serif;
  margin:20px;
  background:#f4f6f9;
  color:#222;
}

h1,h2,h3{
  margin:5px 0;
  text-align:center;
}

button{
  padding:8px 12px;
  border:none;
  border-radius:4px;
  background:#1e3a8a;
  color:white;
  cursor:pointer;
  font-weight:600;
}

button:hover{
  background:#162d6b;
}

input{
  padding:6px;
  margin:5px 5px 5px 0;
}

table{
  border-collapse:collapse;
  width:100%;
  margin-top:10px;
  font-size:12px;
}

th{
  background:#1e3a8a;
  color:white;
  padding:6px;
}

td{
  padding:5px;
  text-align:center;
}

th,td{
  border:1px solid #ccc;
}

tr:nth-child(even){
  background:#f2f4f8;
}

tfoot td{
  font-weight:bold;
  background:#e2e8f0;
}

#app{display:none}

#loginBox{
  max-width:300px;
  margin:auto;
  padding:20px;
  background:white;
  border-radius:8px;
  box-shadow:0 0 10px rgba(0,0,0,0.1);
}

.report-container{
  background:white;
  padding:15px;
  border-radius:8px;
  box-shadow:0 0 10px rgba(0,0,0,0.1);
}

@media print{
  body{
    background:white;
  }
  button,input{
    display:none;
  }
  .report-container{
    box-shadow:none;
    padding:0;
  }
}

</style>
</head>

<body>

<div id="loginBox">
<h2>Login</h2>
<input type="text" id="username" placeholder="Username"><br>
<input type="password" id="password" placeholder="Password"><br>
<button onclick="login()">Login</button>
<p id="loginError" style="color:red;"></p>
</div>

<div id="app">

<h1 id="schoolHeader"></h1>

<input type="text" id="schoolName" placeholder="School Name">
<input type="text" id="year" placeholder="Year">
<input type="file" id="file" accept=".xlsx,.xls">
<button onclick="generateReport()">Generate Report</button>

<br><br>

<button onclick="printReport()">Print</button>
<button onclick="downloadPDF()">Export PDF</button>
<button onclick="exportExcel()">Export Excel</button>

<br><br>

<div id="reportArea" class="report-container">
  <div id="subjectSummary"></div>
  <div id="genderSummary"></div>
</div>

</div>

<script>

function login(){
 if(username.value==="admin" && password.value==="1234"){
  loginBox.style.display="none";
  app.style.display="block";
 }else{
  loginError.innerText="Use admin / 1234";
 }
}

let subjects = {};
let gender = {};

function generateReport(){

 const file = document.getElementById("file").files[0];
 if(!file){ alert("Upload Excel file"); return; }

 const reader = new FileReader();

 reader.onload = e => {

  const wb = XLSX.read(e.target.result,{type:"array"});
  const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

  subjects = {};
  gender = {};

  rows.forEach(row=>{

   const sex = String(row.Sex || "").toUpperCase().trim();
   const project = String(row["PROJECT WORK"] || "X").toUpperCase().trim();
   const achievements = String(row["SUBJECT ACHIEVEMENTS"] || "").trim();

   if(!achievements) return;

   const valid = ["A","B","C","D","E","X"];
   const pg = valid.includes(project) ? project : "X";

   achievements.split(" ").forEach(item=>{

     if(!item.includes("-")) return;

     const [subjectRaw, gradeRaw] = item.split("-");
     const subject = subjectRaw.toUpperCase().trim();
     const grade = gradeRaw.toUpperCase().trim();
     const g = valid.includes(grade) ? grade : "X";

     if(!subjects[subject]){
       subjects[subject] = {
        sat:0,
        A:0,B:0,C:0,D:0,E:0,X:0,
        PA:0,PB:0,PC:0,PD:0,PE:0,PX:0
       };
     }

     subjects[subject].sat++;
     subjects[subject][g]++;
     subjects[subject]["P"+pg]++;

     if(!gender[subject]){
       gender[subject] = {
        MA:0,MB:0,MC:0,MD:0,ME:0,
        FA:0,FB:0,FC:0,FD:0,FE:0
       };
     }

     if(sex==="M" && g!=="X") gender[subject]["M"+g]++;
     if(sex==="F" && g!=="X") gender[subject]["F"+g]++;

   });

  });

  schoolHeader.innerHTML = `
  <h2>${schoolName.value || "SCHOOL NAME"}</h2>
  <h3>UNEB REPORT ${year.value || ""}</h3>
  `;

  renderSubject();
  renderGender();
 };

 reader.readAsArrayBuffer(file);
}


// -------- SUBJECT TABLE WITH TOTALS --------

function renderSubject(){

 let totals = {
   sat:0,A:0,B:0,C:0,D:0,E:0,X:0,
   PA:0,PB:0,PC:0,PD:0,PE:0,PX:0
 };

 let h = `<h2>Subject Summary</h2>
 <table>
 <tr>
 <th>Subject</th><th>Sat</th>
 <th>A</th><th>%A</th>
 <th>B</th><th>%B</th>
 <th>C</th><th>%C</th>
 <th>D</th><th>%D</th>
 <th>E</th><th>%E</th>
 <th>X</th>
 <th>PA</th><th>PB</th><th>PC</th>
 <th>PD</th><th>PE</th><th>PX</th>
 </tr>`;

 Object.keys(subjects).sort().forEach(s=>{

  let x = subjects[s];

  Object.keys(totals).forEach(k=> totals[k]+=x[k]);

  let p = g => x.sat ? ((x[g]/x.sat)*100).toFixed(1) : "0.0";

  h += `<tr>
   <td>${s}</td>
   <td>${x.sat}</td>
   <td>${x.A}</td><td>${p("A")}</td>
   <td>${x.B}</td><td>${p("B")}</td>
   <td>${x.C}</td><td>${p("C")}</td>
   <td>${x.D}</td><td>${p("D")}</td>
   <td>${x.E}</td><td>${p("E")}</td>
   <td>${x.X}</td>
   <td>${x.PA}</td>
   <td>${x.PB}</td>
   <td>${x.PC}</td>
   <td>${x.PD}</td>
   <td>${x.PE}</td>
   <td>${x.PX}</td>
  </tr>`;
 });

 h += `<tfoot>
 <tr>
 <td>TOTAL</td>
 <td>${totals.sat}</td>
 <td>${totals.A}</td><td></td>
 <td>${totals.B}</td><td></td>
 <td>${totals.C}</td><td></td>
 <td>${totals.D}</td><td></td>
 <td>${totals.E}</td><td></td>
 <td>${totals.X}</td>
 <td>${totals.PA}</td>
 <td>${totals.PB}</td>
 <td>${totals.PC}</td>
 <td>${totals.PD}</td>
 <td>${totals.PE}</td>
 <td>${totals.PX}</td>
 </tr>
 </tfoot></table>`;

 subjectSummary.innerHTML = h;
}


// -------- GENDER TABLE WITH TOTALS --------

function renderGender(){

 let totals = {
  MA:0,MB:0,MC:0,MD:0,ME:0,
  FA:0,FB:0,FC:0,FD:0,FE:0
 };

 let h = `<h2>Gender Summary</h2>
 <table>
 <tr>
 <th>Subject</th>
 <th>MA</th><th>MB</th><th>MC</th><th>MD</th><th>ME</th>
 <th>FA</th><th>FB</th><th>FC</th><th>FD</th><th>FE</th>
 </tr>`;

 Object.keys(gender).sort().forEach(s=>{

  let g = gender[s];
  Object.keys(totals).forEach(k=> totals[k]+=g[k]);

  h += `<tr>
   <td>${s}</td>
   <td>${g.MA}</td><td>${g.MB}</td><td>${g.MC}</td>
   <td>${g.MD}</td><td>${g.ME}</td>
   <td>${g.FA}</td><td>${g.FB}</td><td>${g.FC}</td>
   <td>${g.FD}</td><td>${g.FE}</td>
  </tr>`;
 });

 h += `<tfoot>
 <tr>
 <td>TOTAL</td>
 <td>${totals.MA}</td><td>${totals.MB}</td>
 <td>${totals.MC}</td><td>${totals.MD}</td>
 <td>${totals.ME}</td>
 <td>${totals.FA}</td><td>${totals.FB}</td>
 <td>${totals.FC}</td><td>${totals.FD}</td>
 <td>${totals.FE}</td>
 </tr>
 </tfoot></table>`;

 genderSummary.innerHTML = h;
}


// PRINT
function printReport(){
 window.print();
}

// PDF
function downloadPDF(){
 const element = document.getElementById("reportArea");
 html2pdf().set({
   margin:5,
   filename:'UNEB_Report.pdf',
   html2canvas:{scale:2},
   jsPDF:{orientation:'landscape'}
 }).from(element).save();
}

// EXCEL
function exportExcel(){
 let data = [["Subject","Sat","A","B","C","D","E","X","PA","PB","PC","PD","PE","PX"]];
 Object.keys(subjects).forEach(s=>{
   let x = subjects[s];
   data.push([s,x.sat,x.A,x.B,x.C,x.D,x.E,x.X,x.PA,x.PB,x.PC,x.PD,x.PE,x.PX]);
 });
 const ws = XLSX.utils.aoa_to_sheet(data);
 const wb = XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb, ws, "Subject Summary");
 XLSX.writeFile(wb,"UNEB_Report.xlsx");
}

</script>
</body>
</html>
