<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>UNEB Report System</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body{font-family:Arial;margin:20px}
table{border-collapse:collapse;width:100%;margin-top:15px}
th,td{border:1px solid #000;padding:6px;text-align:center;font-size:13px}
th{background:#eee}
input,button{padding:6px;margin:5px 0}
#app{display:none}
#loginBox{max-width:300px;margin:auto;padding:20px;border:1px solid #ccc}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginBox">
<h2>Login</h2>
<input type="text" id="username" placeholder="Username"><br>
<input type="password" id="password" placeholder="Password"><br>
<button onclick="login()">Login</button>
<p id="loginError" style="color:red;"></p>
</div>

<!-- MAIN APP -->
<div id="app">

<h1 id="schoolHeader"></h1>

<input type="text" id="schoolName" placeholder="School Name">
<input type="text" id="year" placeholder="Year">
<input type="file" id="file" accept=".xlsx,.xls">
<button onclick="generateReport()">Generate Report</button>

<div id="subjectSummary"></div>
<div id="genderSummary"></div>

</div>

<script>

function login(){
 if(username.value==="admin" && password.value==="1234"){
  loginBox.style.display="none";
  app.style.display="block";
 }else{
  loginError.innerText="Use admin / 1234";
 }
}

let subjects = {};
let gender = {};

function generateReport(){

 const file = document.getElementById("file").files[0];
 if(!file){ alert("Upload Excel file"); return; }

 const reader = new FileReader();

 reader.onload = e => {

  const wb = XLSX.read(e.target.result,{type:"array"});
  const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

  subjects = {};
  gender = {};

  rows.forEach(row=>{

   const sex = String(row.Sex || "").toUpperCase().trim();
   const project = String(row["PROJECT WORK"] || "X").toUpperCase().trim();
   const achievements = String(row["SUBJECT ACHIEVEMENTS"] || "").trim();

   if(!achievements) return;

   const valid = ["A","B","C","D","E","X"];
   const pg = valid.includes(project) ? project : "X";

   // Split subjects like: ENG-B CRE-C HIS-C
   const parts = achievements.split(" ");

   parts.forEach(item=>{

     if(!item.includes("-")) return;

     const [subjectRaw, gradeRaw] = item.split("-");
     const subject = subjectRaw.toUpperCase().trim();
     const grade = gradeRaw.toUpperCase().trim();
     const g = valid.includes(grade) ? grade : "X";

     if(!subjects[subject]){
       subjects[subject] = {
        sat:0,
        A:0,B:0,C:0,D:0,E:0,X:0,
        PA:0,PB:0,PC:0,PD:0,PE:0,PX:0
       };
     }

     subjects[subject].sat++;
     subjects[subject][g]++;
     subjects[subject]["P"+pg]++;

     if(!gender[subject]){
       gender[subject] = {
        MA:0,MB:0,MC:0,MD:0,ME:0,
        FA:0,FB:0,FC:0,FD:0,FE:0
       };
     }

     if(sex==="M" && g!=="X") gender[subject]["M"+g]++;
     if(sex==="F" && g!=="X") gender[subject]["F"+g]++;

   });

  });

  schoolHeader.innerHTML = `
  <h2>${schoolName.value || "SCHOOL NAME"}</h2>
  <h3>UNEB REPORT ${year.value || ""}</h3>
  `;

  renderSubject();
  renderGender();

 };

 reader.readAsArrayBuffer(file);
}


// ---------- SUBJECT TABLE ----------

function renderSubject(){

 let h = `<h2>Subject Summary</h2>
 <table>
 <tr>
 <th>Subject</th><th>Sat</th>
 <th>A</th><th>%A</th>
 <th>B</th><th>%B</th>
 <th>C</th><th>%C</th>
 <th>D</th><th>%D</th>
 <th>E</th><th>%E</th>
 <th>X</th>
 <th>PA</th><th>PB</th><th>PC</th><th>PD</th><th>PE</th><th>PX</th>
 </tr>`;

 Object.keys(subjects)
 .sort((a,b)=>a.localeCompare(b))
 .forEach(s=>{

  let x = subjects[s];
  let p = g => x.sat ? ((x[g]/x.sat)*100).toFixed(1) : "0.0";

  h += `<tr>
   <td>${s}</td>
   <td>${x.sat}</td>
   <td>${x.A}</td><td>${p("A")}</td>
   <td>${x.B}</td><td>${p("B")}</td>
   <td>${x.C}</td><td>${p("C")}</td>
   <td>${x.D}</td><td>${p("D")}</td>
   <td>${x.E}</td><td>${p("E")}</td>
   <td>${x.X}</td>
   <td>${x.PA}</td>
   <td>${x.PB}</td>
   <td>${x.PC}</td>
   <td>${x.PD}</td>
   <td>${x.PE}</td>
   <td>${x.PX}</td>
  </tr>`;
 });

 h += "</table>";
 subjectSummary.innerHTML = h;
}


// ---------- GENDER TABLE ----------

function renderGender(){

 let h = `<h2>Gender Summary</h2>
 <table>
 <tr>
 <th>Subject</th>
 <th>MA</th><th>MB</th><th>MC</th><th>MD</th><th>ME</th>
 <th>FA</th><th>FB</th><th>FC</th><th>FD</th><th>FE</th>
 </tr>`;

 Object.keys(gender)
 .sort((a,b)=>a.localeCompare(b))
 .forEach(s=>{

  let g = gender[s];

  h += `<tr>
   <td>${s}</td>
   <td>${g.MA}</td><td>${g.MB}</td><td>${g.MC}</td><td>${g.MD}</td><td>${g.ME}</td>
   <td>${g.FA}</td><td>${g.FB}</td><td>${g.FC}</td><td>${g.FD}</td><td>${g.FE}</td>
  </tr>`;
 });

 h += "</table>";
 genderSummary.innerHTML = h;
}

</script>
</body>
</html>
