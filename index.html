<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>UNEB Automatic Report System</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body{font-family:Arial;background:#f4f6fb;margin:0}
header{background:#1a4d8f;color:#fff;padding:15px;text-align:center}
.container{padding:20px}
table{width:100%;border-collapse:collapse;margin-top:20px;background:#fff}
th,td{border:1px solid #ccc;padding:8px;text-align:center}
th{background:#e9eef3}
button{background:#1a4d8f;color:#fff;padding:10px 16px;border:none;border-radius:5px;cursor:pointer;margin:5px}
button:hover{background:#163f73}
input{padding:8px;margin:5px;width:100%}

@media print{
  button,input{display:none}
  body{background:#fff}
}
</style>
</head>

<body>

<header>
  <h1 id="schoolHeader">UNEB AUTOMATIC SUBJECT SUMMARY</h1>
</header>

<!-- LOGIN -->
<div id="loginBox" style="max-width:400px;margin:60px auto;background:#fff;padding:20px;border-radius:10px">
  <h2 style="text-align:center">School Login (Demo)</h2>
  <input id="username" placeholder="Username">
  <input id="password" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
  <p id="loginError" style="color:red;text-align:center"></p>
</div>

<!-- APP -->
<div id="app" style="display:none">
<div class="container">

<input id="schoolName" placeholder="School Name">
<input id="year" placeholder="Year">
<input type="file" id="file" accept=".xlsx">

<button onclick="generateReport()">Generate UNEB Report</button>
<button onclick="exportSubject()">Export Subject Summary</button>
<button onclick="exportGender()">Export Gender Summary</button>
<button onclick="window.print()">Print UNEB Report</button>

<div id="subjectSummary"></div>
<div id="genderSummary"></div>

</div>
</div>

<script>
/* ---------- LOGIN ---------- */
function login(){
  if(username.value==="admin" && password.value==="1234"){
    loginBox.style.display="none";
    app.style.display="block";
  }else{
    loginError.innerText="Use admin / 1234";
  }
}

/* ---------- DATA STORES ---------- */
let subjectTotals = {};
let genderTotals = {};

/* ---------- GENERATE REPORT ---------- */
function generateReport(){
  const file = document.getElementById("file").files[0];
  if(!file){ alert("Upload Excel file"); return; }

  const reader = new FileReader();
  reader.onload = e => {
    const wb = XLSX.read(e.target.result,{type:"binary"});
    const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

    subjectTotals = {};
    genderTotals = {};

    rows.forEach(row=>{
      const sex = (row.SEX || "").toUpperCase();
      const subjectsCell = row.SUBJECTS || "";

      const items = subjectsCell.split(" ");

      items.forEach(it=>{
        if(!it.includes("-")) return;

        let [sub, grade] = it.split("-");
        sub = sub.trim().toUpperCase();
        grade = grade.trim().toUpperCase();

        if(!["A","B","C","D","E","X"].includes(grade)) grade = "X";

        if(!subjectTotals[sub]){
          subjectTotals[sub] = {A:0,B:0,C:0,D:0,E:0,X:0};
        }
        subjectTotals[sub][grade]++;

        if(!genderTotals[sub]){
          genderTotals[sub] = {
            MA:0,MB:0,MC:0,MD:0,ME:0,
            FA:0,FB:0,FC:0,FD:0,FE:0
          };
        }

        if(sex==="M" && grade!=="X") genderTotals[sub]["M"+grade]++;
        if(sex==="F" && grade!=="X") genderTotals[sub]["F"+grade]++;
      });
    });

    schoolHeader.innerText =
      (schoolName.value || "SCHOOL") + " â€“ UNEB REPORT " + (year.value || "");

    renderSubjectTable();
    renderGenderTable();
  };

  reader.readAsBinaryString(file);
}

/* ---------- SUBJECT TABLE ---------- */
function renderSubjectTable(){
  let html="<h2>Subject Summary</h2><table><tr><th>Subject</th><th>A</th><th>B</th><th>C</th><th>D</th><th>E</th><th>X</th></tr>";

  Object.keys(subjectTotals).sort((a,b)=>{
    if(a==="PROJECT") return 1;
    if(b==="PROJECT") return -1;
    return a.localeCompare(b);
  }).forEach(sub=>{
    const s = subjectTotals[sub];
    html+=`<tr>
      <td>${sub}</td>
      <td>${s.A}</td>
      <td>${s.B}</td>
      <td>${s.C}</td>
      <td>${s.D}</td>
      <td>${s.E}</td>
      <td>${s.X}</td>
    </tr>`;
  });

  html+="</table>";
  subjectSummary.innerHTML=html;
}

/* ---------- GENDER TABLE ---------- */
function renderGenderTable(){
  let html="<h2>Gender Summary</h2><table><tr><th>Subject</th><th>MA</th><th>MB</th><th>MC</th><th>MD</th><th>ME</th><th>FA</th><th>FB</th><th>FC</th><th>FD</th><th>FE</th></tr>";

  Object.keys(genderTotals).forEach(sub=>{
    const g = genderTotals[sub];
    html+=`<tr>
      <td>${sub}</td>
      <td>${g.MA}</td><td>${g.MB}</td><td>${g.MC}</td><td>${g.MD}</td><td>${g.ME}</td>
      <td>${g.FA}</td><td>${g.FB}</td><td>${g.FC}</td><td>${g.FD}</td><td>${g.FE}</td>
    </tr>`;
  });

  html+="</table>";
  genderSummary.innerHTML=html;
}

/* ---------- EXPORTS ---------- */
function exportSubject(){
  const data = Object.keys(subjectTotals).map(s=>({Subject:s,...subjectTotals[s]}));
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Subject Summary");
  XLSX.writeFile(wb,"subject_summary.xlsx");
}

function exportGender(){
  const data = Object.keys(genderTotals).map(s=>({Subject:s,...genderTotals[s]}));
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Gender Summary");
  XLSX.writeFile(wb,"gender_summary.xlsx");
}
</script>

</body>
</html>
